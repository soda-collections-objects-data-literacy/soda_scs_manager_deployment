# Number of worker processes - 'auto' detects CPU cores and creates one worker per core.
# This maximizes CPU utilization for handling concurrent requests.
worker_processes auto;

# Location and level of error logging.
# 'warn' logs warnings and errors but not info/debug messages.
error_log /var/log/nginx/error.log warn;

# Process ID file - used by system tools to manage nginx (start/stop/reload).
pid /var/run/nginx.pid;

events {
    # Maximum number of simultaneous connections each worker can handle.
    # Total capacity = worker_processes × worker_connections.
    worker_connections 1024;
}

http {
    # Load file extension to MIME type mappings (e.g., .pdf → application/pdf).
    include /etc/nginx/mime.types;

    # Default MIME type for unknown file extensions - tells browser to download as binary.
    default_type application/octet-stream;

    # Define format for access logs with common fields.
    # $remote_addr: client IP, $request: HTTP request, $status: response code, etc.
    log_format main '$remote_addr - $remote_user [$time_local] "$request" '
                    '$status $body_bytes_sent "$http_referer" '
                    '"$http_user_agent" "$http_x_forwarded_for"';

    # Write access logs using the 'main' format defined above.
    access_log /var/log/nginx/access.log main;

    # Use kernel-level file transmission - much faster for serving static files.
    sendfile on;

    # Wait until packet is full before sending - reduces number of packets.
    tcp_nopush on;

    # Disable Nagle's algorithm - send data immediately for real-time applications.
    tcp_nodelay on;

    # Keep client connections open for 65 seconds to reuse connections.
    keepalive_timeout 65;

    # Size of hash table for MIME types lookup - performance optimization.
    types_hash_max_size 2048;

    # Create variable $the_scheme containing the actual protocol (http/https).
    # If X-Forwarded-Proto header exists (from Traefik), use it; otherwise use nginx's $scheme.
    # This ensures we know the original client protocol despite being behind a proxy.
    map $http_x_forwarded_proto $the_scheme {
        default $http_x_forwarded_proto;
        "" $scheme;
    }

    # Create variable $the_real_ip containing the actual client IP address.
    # If X-Forwarded-For header exists, use it; otherwise use $remote_addr (Traefik's IP).
    # This preserves the real client IP through the proxy chain.
    map $http_x_forwarded_for $the_real_ip {
        default $http_x_forwarded_for;
        "" $remote_addr;
    }

    # Define backend server group for load balancing and connection pooling.
    upstream backend {
        # OnlyOffice document server location - Docker service name resolves via internal DNS.
        server nextcloud--onlyoffice-document-server:80;

        # Maintain up to 32 persistent connections to backend - dramatically reduces latency.
        # Connections are reused instead of creating new TCP connections for each request.
        keepalive 32;
    }

    server {
        # Listen on port 80 inside container - Traefik handles HTTPS externally.
        listen 80;

        # Match any hostname - '_' is nginx wildcard for "default server".
        # Traefik already filtered by hostname before forwarding here.
        server_name _;

        # Maximum size of request body (file uploads) - allows uploading documents up to 100MB.
        client_max_body_size 100M;

        # Buffer size for reading client request bodies - larger buffer = fewer disk writes.
        client_body_buffer_size 128k;

        # Number and size of buffers for reading backend responses (8 buffers × 256KB = 2MB).
        # OnlyOffice sends large responses (document data), needs bigger buffers.
        proxy_buffers 8 256k;

        # Buffer size for reading response headers from backend.
        # OnlyOffice may send large headers (JWT tokens, metadata).
        proxy_buffer_size 256k;

        # Timeout for establishing connection to backend - 10 minutes.
        # OnlyOffice container might be slow to respond under heavy load.
        proxy_connect_timeout 600s;

        # Timeout for sending data to backend - 10 minutes for large uploads.
        proxy_send_timeout 600s;

        # Timeout for reading response from backend - critical for collaborative editing.
        # WebSocket connections stay open for entire editing session.
        proxy_read_timeout 600s;

        # Match all requests starting with / (root location - matches everything).
        location / {
            # Forward all requests to the 'backend' upstream defined above.
            proxy_pass http://backend;

            # Use HTTP/1.1 for backend connections - required for WebSockets and persistent connections.
            # HTTP/1.0 doesn't support these features.
            proxy_http_version 1.1;

            # Pass Upgrade header for WebSocket protocol upgrade (HTTP → WebSocket).
            # When client sends "Upgrade: websocket", forward it to OnlyOffice intact.
            proxy_set_header Upgrade $http_upgrade;

            # Pass Connection header for WebSocket handshake.
            # Works with Upgrade header to complete WebSocket connection.
            proxy_set_header Connection $http_connection;

            # Forward original Host header (e.g., "office.scs.sammlungen.io").
            # OnlyOffice needs this to generate correct URLs in responses.
            proxy_set_header Host $http_host;

            # Send actual client IP to OnlyOffice (not Traefik's IP).
            # OnlyOffice logs will show real users instead of just proxy IPs.
            proxy_set_header X-Real-IP $the_real_ip;

            # Build chain of IPs through all proxies for full tracking.
            # Example: "203.0.113.5, 172.17.0.2, 10.0.0.1" (client, Traefik, this nginx).
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;

            # CRITICAL: Force HTTPS protocol in header - fixes callback URL generation.
            # Without this, OnlyOffice generates HTTP callbacks which get 308 redirected.
            # With this, OnlyOffice knows it's behind HTTPS and generates correct HTTPS URLs.
            proxy_set_header X-Forwarded-Proto https;

            # Preserve original hostname through proxy chain.
            # Backup for Host header, used by some applications.
            proxy_set_header X-Forwarded-Host $http_host;

            # Disable response buffering - stream data to client as it arrives.
            # Critical for real-time collaboration and WebSocket data flow.
            proxy_buffering off;

            # Disable request buffering - stream uploads to backend as they arrive.
            # Improves memory efficiency and enables accurate upload progress.
            proxy_request_buffering off;

            # Disable automatic rewriting of Location headers in redirects.
            # OnlyOffice generates correct redirect URLs itself using our forwarded headers.
            proxy_redirect off;
        }
    }
}
