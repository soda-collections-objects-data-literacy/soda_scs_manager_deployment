# Docker Compose Override for SCS Nextcloud Stack Integration
# This file overrides the base docker-compose.yml to integrate with the main SCS deployment
# It adds Traefik integration, proper networking, and consistent naming

services:
  # Nextcloud FPM
  nextcloud--nextcloud:
    container_name: nextcloud--nextcloud
    environment:
      # Override database host to use parent stack's database
      - MYSQL_HOST=scs--database
    volumes:
      - ${SCS_ROOT_PATH}/scs-nextcloud-stack/hooks/post-installation:/docker-entrypoint-hooks.d/post-installation
    networks:
      - default
      - reverse-proxy
    labels:
      - "traefik.enable=false"

  # OnlyOffice Document Server
  nextcloud--onlyoffice-document-server:
    container_name: nextcloud--onlyoffice-document-server
    networks:
      - default
      - reverse-proxy
    labels:
      - "traefik.enable=false"

  # Nginx Reverse Proxy for Nextcloud with Traefik
  nextcloud--nextcloud-reverse-proxy:
    container_name: nextcloud--nextcloud-reverse-proxy
    volumes:
      - ${SCS_ROOT_PATH}/scs-nextcloud-stack/reverse-proxy/nginx.conf:/etc/nginx/nginx.conf
    networks:
      - default
      - reverse-proxy
    ports: !reset []  # Remove port binding, use Traefik instead
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=reverse-proxy"
      - "traefik.http.routers.nextcloud--nextcloud-reverse-proxy.rule=Host(`${NEXTCLOUD_NEXTCLOUD_DOMAIN}`)"
      - "traefik.http.routers.nextcloud--nextcloud-reverse-proxy.entrypoints=web,websecure"
      - "traefik.http.routers.nextcloud--nextcloud-reverse-proxy.middlewares=https-redirect,nextcloud-redirectregex,nextcloud-webfinger,nextcloud-nodeinfo"
      - "traefik.http.routers.nextcloud--nextcloud-reverse-proxy.tls=true"
      - "traefik.http.routers.nextcloud--nextcloud-reverse-proxy.tls.certresolver=le"
      - "traefik.http.services.nextcloud--nextcloud-reverse-proxy.loadbalancer.server.port=80"

  # OnlyOffice Reverse Proxy with Traefik
  nextcloud--onlyoffice-reverse-proxy:
    container_name: nextcloud--onlyoffice-reverse-proxy
    volumes:
      - ${SCS_ROOT_PATH}/scs-nextcloud-stack/onlyoffice-proxy/nginx.conf:/etc/nginx/nginx.conf
    networks:
      - default
      - reverse-proxy
    ports: !reset []  # Remove port binding, use Traefik instead
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=reverse-proxy"
      - "traefik.http.routers.nextcloud--onlyoffice-reverse-proxy.rule=Host(`${NEXTCLOUD_ONLYOFFICE_DOMAIN}`)"
      - "traefik.http.routers.nextcloud--onlyoffice-reverse-proxy.entrypoints=web,websecure"
      - "traefik.http.routers.nextcloud--onlyoffice-reverse-proxy.middlewares=https-redirect"
      - "traefik.http.routers.nextcloud--onlyoffice-reverse-proxy.tls=true"
      - "traefik.http.routers.nextcloud--onlyoffice-reverse-proxy.tls.certresolver=le"
      - "traefik.http.services.nextcloud--onlyoffice-reverse-proxy.loadbalancer.server.port=80"

  # Redis for Nextcloud caching
  nextcloud--redis:
    container_name: nextcloud--redis

# Networks
networks:
  reverse-proxy:
    name: reverse-proxy
    external: true
