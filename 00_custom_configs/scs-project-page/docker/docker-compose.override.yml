services:
  # Project page Drupal service using the root database.
  scs-project-page--drupal:
    build:
      context: ./scs-project-page-stack
      dockerfile: Dockerfile
      args:
        MODE: ${MODE}
    container_name: scs-project-page--drupal
    depends_on:
      - scs--database
    volumes:
      - ./scs-project-page-stack/volumes/drupal-root:/opt/drupal
      - ./scs-project-page-stack/volumes/database/state:/var/database_state
    environment:
      DB_DRIVER: ${PROJECT_WEBSITE_DB_DRIVER}
      DB_HOST: ${PROJECT_WEBSITE_DB_HOST}
      DB_NAME: ${PROJECT_WEBSITE_DB_NAME}
      DB_PASSWORD: ${PROJECT_WEBSITE_DB_PASSWORD}
      DB_PORT: ${PROJECT_WEBSITE_DB_PORT}
      DB_USER: ${PROJECT_WEBSITE_DB_USER}
    ports: !reset []
    networks:
      - reverse-proxy
    external_links:
      - scs--database

  # Project page Redis service.
  scs-project-page--redis:
    image: redis:${REDIS_IMAGE_VERSION:-8-alpine}
    container_name: scs-project-page--redis
    restart: always
    command: redis-server --maxmemory 512mb --maxmemory-policy allkeys-lru --save 60 1000 --appendonly yes
    volumes:
      - scs-project-page--redis-data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 10s
      retries: 3
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 768M
        reservations:
          cpus: '0.25'
          memory: 256M
    networks:
      - reverse-proxy

  # Project page Varnish service exposed via Traefik.
  scs-project-page--varnish:
    image: ghcr.io/soda-collections-objects-data-literacy/scs-varnish:${SCS_VARNISH_IMAGE_VERSION:-1.0.0}
    container_name: scs-project-page--varnish
    restart: always
    depends_on:
      scs-project-page--drupal:
        condition: service_started
    environment:
      - VARNISH_BACKEND_HOST=scs-project-page--drupal
      - VARNISH_BACKEND_PORT=80
      - VARNISH_SIZE=256M
    tmpfs:
      - /var/lib/varnish/varnishd:exec,uid=999,gid=999
    ports: !reset []
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 512M
        reservations:
          cpus: '0.25'
          memory: 256M
    ulimits:
      memlock:
        soft: 536870912
        hard: 536870912
    healthcheck:
      test: ["CMD", "varnishstat", "-1"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 10s
    networks:
      - reverse-proxy
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=reverse-proxy"
      - "traefik.http.routers.scs-project-page--varnish.rule=Host(`${PROJECT_WEBSITE_DOMAIN}`)"
      - "traefik.http.routers.scs-project-page--varnish.entrypoints=web,websecure"
      - "traefik.http.routers.scs-project-page--varnish.middlewares=https-redirect"
      - "traefik.http.routers.scs-project-page--varnish.tls=true"
      - "traefik.http.routers.scs-project-page--varnish.tls.certresolver=le"
      - "traefik.http.routers.scs-project-page--varnish.service=scs-project-page--varnish"
      - "traefik.http.services.scs-project-page--varnish.loadbalancer.server.port=80"

volumes:
  scs-project-page--redis-data:
    name: scs-project-page--redis-data

networks:
  reverse-proxy:
    external: true
