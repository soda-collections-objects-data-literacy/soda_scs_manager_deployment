services:
  # Project page Drupal service using the root database.
  scs-project-website--drupal:
    build:
      context: ./scs-project-website-stack
      dockerfile: Dockerfile
      args:
        MODE: ${MODE}
    container_name: scs-project-website--drupal
    depends_on:
      - scs--database
    volumes:
      - ./scs-project-website-stack/volumes/drupal-root:/opt/drupal
      - ./scs-project-website-stack/volumes/database/state:/var/database_state
    environment:
      DB_DRIVER: ${PROJECT_WEBSITE_DB_DRIVER}
      DB_HOST: ${PROJECT_WEBSITE_DB_HOST}
      DB_NAME: ${PROJECT_WEBSITE_DB_NAME}
      DB_PASSWORD: ${PROJECT_WEBSITE_DB_PASSWORD}
      DB_PORT: ${PROJECT_WEBSITE_DB_PORT}
      DB_USER: ${PROJECT_WEBSITE_DB_USER}
    ports: !reset []
    networks:
      - reverse-proxy
    external_links:
      - scs--database

  # Project page Redis service.
  scs-project-website--redis:
    image: redis:${REDIS_IMAGE_VERSION:-8-alpine}
    container_name: scs-project-website--redis
    restart: always
    command: redis-server --maxmemory 512mb --maxmemory-policy allkeys-lru --save 60 1000 --appendonly yes
    volumes:
      - scs-project-website--redis-data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 10s
      retries: 3
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 768M
        reservations:
          cpus: '0.25'
          memory: 256M
    networks:
      - reverse-proxy

  # Project page Varnish service exposed via Traefik.
  scs-project-website--varnish:
    image: ghcr.io/soda-collections-objects-data-literacy/scs-varnish:${SCS_VARNISH_IMAGE_VERSION:-1.0.0}
    container_name: scs-project-website--varnish
    restart: always
    depends_on:
      scs-project-website--drupal:
        condition: service_started
    environment:
      - VARNISH_BACKEND_HOST=scs-project-website--drupal
      - VARNISH_BACKEND_PORT=80
      - VARNISH_SIZE=256M
    volumes:
      - /var/deploy/soda_scs_manager_deployment/scs-project-website-stack/varnish/default.vcl:/etc/varnish/default.vcl:ro
    entrypoint: ["/usr/sbin/varnishd"]
    command: ["-F", "-f", "/etc/varnish/default.vcl", "-a", ":80", "-s", "malloc,256M"]
    tmpfs:
      - /var/lib/varnish/varnishd:exec,uid=999,gid=999
    ports:
      - "3099:80"
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 512M
        reservations:
          cpus: '0.25'
          memory: 256M
    ulimits:
      memlock:
        soft: 536870912
        hard: 536870912
    healthcheck:
      test: ["CMD", "varnishstat", "-1"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 10s
    networks:
      - reverse-proxy
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=reverse-proxy"
      # Main domain route
      - "traefik.http.routers.scs-project-website--varnish.rule=Host(`${PROJECT_WEBSITE_DOMAIN}`)"
      - "traefik.http.routers.scs-project-website--varnish.entrypoints=websecure"
      - "traefik.http.routers.scs-project-website--varnish.middlewares=rate-limit-high"
      - "traefik.http.routers.scs-project-website--varnish.tls=true"
      - "traefik.http.routers.scs-project-website--varnish.tls.certresolver=le"
      - "traefik.http.routers.scs-project-website--varnish.service=scs-project-website--varnish"
      # Service definition
      - "traefik.http.services.scs-project-website--varnish.loadbalancer.server.port=80"

volumes:
  scs-project-website--redis-data:
    name: scs-project-website--redis-data

networks:
  reverse-proxy:
    external: true
