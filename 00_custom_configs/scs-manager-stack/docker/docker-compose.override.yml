# Docker Compose Override for SCS Manager Stack Integration
# This file overrides the base docker-compose.yml to integrate with the main SCS deployment
# It adds Traefik integration, proper networking, and uses parent stack's database

services:
  # Drupal with NGINX
  scs-manager--drupal:
    container_name: scs-manager--drupal
    environment:
      # Override to use parent stack's database
      DB_HOST: scs--database
    volumes:
      - scs-manager--drupal-sites:/opt/drupal/web/sites
      - /var/backups/scs-manager/snapshots:/var/scs-manager/snapshots
    networks:
      - default
      - reverse-proxy
    ports: !reset []  # Remove port binding, use Varnish with Traefik
    extra_hosts:
      - "host.docker.internal:host-gateway"
    labels:
      - "traefik.enable=true"  # Varnish handles the routing
      - "traefik.http.routers.scs-manager--drupal.rule=Host(`raw.${SCS_MANAGER_DOMAIN}`)"
      - "traefik.http.routers.scs-manager--drupal.entrypoints=web,websecure"
      - "traefik.http.routers.scs-manager--drupal.middlewares=https-redirect"
      - "traefik.http.routers.scs-manager--drupal.tls=true"
      - "traefik.http.routers.scs-manager--drupal.tls.certresolver=le"
      - "traefik.http.services.scs-manager--drupal.loadbalancer.server.port=80"

  # Don't start local database - use parent stack's database instead
  scs-manager--database:
    deploy:
      replicas: 0

  # Redis
  scs-manager--redis:
    container_name: scs-manager-redis
    networks:
      - default
    labels:
      - "traefik.enable=false"

  # Varnish with Traefik Integration
  scs-manager--varnish:
    container_name: scs-manager--varnish
    environment:
      # Override to use correct container name
      - VARNISH_BACKEND_HOST=scs-manager--drupal
      - VARNISH_BACKEND_PORT=80
      - VARNISH_SIZE=256M
    volumes:
      - /var/deploy/soda_scs_manager_deployment/scs-manager-stack/varnish/default.vcl:/etc/varnish/default.vcl:ro
    entrypoint: ["/usr/sbin/varnishd"]
    command: ["-F", "-f", "/etc/varnish/default.vcl", "-a", ":80", "-s", "malloc,256M"]
    networks:
      - default
      - reverse-proxy
    ports: !reset []  # Remove port binding, use Traefik instead
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=reverse-proxy"
      - "traefik.http.routers.scs-manager--varnish.rule=Host(`${SCS_MANAGER_DOMAIN}`)"
      - "traefik.http.routers.scs-manager--varnish.entrypoints=web,websecure"
      - "traefik.http.routers.scs-manager--varnish.middlewares=https-redirect,rate-limit-high"
      - "traefik.http.routers.scs-manager--varnish.tls=true"
      - "traefik.http.routers.scs-manager--varnish.tls.certresolver=le"
      - "traefik.http.routers.scs-manager--varnish.service=scs-manager--varnish"
      - "traefik.http.services.scs-manager--varnish.loadbalancer.server.port=80"

# Networks
networks:
  reverse-proxy:
    name: reverse-proxy
    external: true
  default:
    name: scs-manager
    driver: bridge
