# Docker Compose Override for SCS Manager Stack Integration
# This file overrides the base docker-compose.yml to integrate with the main SCS deployment
# It adds Traefik integration, proper networking, and uses parent stack's database

services:
  # Drupal with NGINX
  scs-manager--drupal:
    container_name: scs-manager--drupal
    restart: unless-stopped
    environment:
      # Override to use parent stack's database
      DB_HOST: scs--database
      # Pass through Drupal configuration
      DRUPAL_TRUSTED_HOSTS: ${SCS_MANAGER_DRUPAL_TRUSTED_HOSTS}
      DRUPAL_PROXY_ADDRESSES: ${SCS_MANAGER_DRUPAL_PROXY_ADDRESSES}
    volumes:
      - ./scs-manager-stack/custom_configs/sync:/opt/drupal/custom_configs/sync
      - ./scs-manager-stack/configs/php-fpm/zz-docker.conf:/usr/local/etc/php-fpm.d/zz-docker.conf:ro
      - /srv/backups/scs-manager/snapshots:/var/scs-manager/snapshots
      # Workaround: Mount PHP-FPM config to fix socket issue until image is rebuilt
    networks: !override
      - default
      - reverse-proxy
    ports: !reset []  # Remove port binding, use Varnish with Traefik
    depends_on: !override
      - scs--reverse-proxy
      - scs--database
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=reverse-proxy"
      - "traefik.http.routers.scs-manager--drupal.rule=Host(`${SCS_MANAGER_DOMAIN}`)"
      - "traefik.http.routers.scs-manager--drupal.entrypoints=websecure"
      - "traefik.http.routers.scs-manager--drupal.tls=true"
      - "traefik.http.routers.scs-manager--drupal.tls.certresolver=le"
      - "traefik.http.services.scs-manager--drupal.loadbalancer.server.port=80"


  # Don't start local database - use parent stack's database instead
  scs-manager--database:
    deploy:
      replicas: 0

  # Redis
  scs-manager--redis:
    container_name: scs-manager--redis
    networks:
      - default
    labels:
      - "traefik.enable=false"

  # Varnish with Traefik Integration
  scs-manager--varnish:
    deploy:
      replicas: 0

# Networks
networks:
  default:
    name: scs-manager
    driver: bridge

volumes:
  scs-manager--custom-modules:
    name: scs-manager--custom-modules
    driver: local

