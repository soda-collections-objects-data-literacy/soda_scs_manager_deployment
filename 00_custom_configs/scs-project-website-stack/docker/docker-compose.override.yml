services:
  # Disable local database - use parent database instead.
  scs-project-website--database:
    deploy:
      replicas: 0

  # Drupal - connect to parent database via reverse-proxy network.
  scs-project-website--drupal:
    build:
      context: scs-project-website-stack
    depends_on:
      - scs--database
    volumes: !override
      - scs-project-website-data:/opt/drupal/web/sites
    environment:
      DB_DRIVER: ${PROJECT_WEBSITE_DB_DRIVER}
      DB_HOST: ${PROJECT_WEBSITE_DB_HOST}
      DB_NAME: ${PROJECT_WEBSITE_DB_NAME}
      DB_PASSWORD: ${PROJECT_WEBSITE_DB_PASSWORD}
      DB_PORT: ${PROJECT_WEBSITE_DB_PORT}
      DB_USER: ${PROJECT_WEBSITE_DB_USER}
      DRUPAL_SITE_NAME: ${PROJECT_WEBSITE_SITE_NAME}
      DRUPAL_ADMIN_USER: ${PROJECT_WEBSITE_ADMIN_NAME}
      DRUPAL_ADMIN_PASSWORD: ${PROJECT_WEBSITE_ADMIN_PASSWORD}
      DRUPAL_ADMIN_EMAIL: ${PROJECT_WEBSITE_ADMIN_EMAIL}
    networks:
      - reverse-proxy

  # Redis - add to reverse-proxy network.
  scs-project-website--redis:
    networks:
      - reverse-proxy

  # Varnish - expose via Traefik and direct port 3099.
  scs-project-website--varnish:
    networks:
      - reverse-proxy
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=reverse-proxy"
      - "traefik.http.routers.scs-project-website--varnish.rule=Host(`${PROJECT_WEBSITE_DOMAIN}`)"
      - "traefik.http.routers.scs-project-website--varnish.entrypoints=websecure"
      - "traefik.http.routers.scs-project-website--varnish.tls=true"
      - "traefik.http.routers.scs-project-website--varnish.tls.certresolver=le"
      - "traefik.http.services.scs-project-website--varnish.loadbalancer.server.port=80"

volumes:
  scs-project-website-data:
