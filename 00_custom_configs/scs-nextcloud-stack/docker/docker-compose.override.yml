# Docker Compose Override for SCS Nextcloud Stack Integration
# This file overrides the base docker-compose.yml to integrate with the main SCS deployment
# It adds Traefik integration, proper networking, and consistent naming

services:
  # Nextcloud FPM
  nextcloud--nextcloud:
    container_name: nextcloud--nextcloud
    environment:
      # Override database host to use parent stack's database.
      - MYSQL_HOST=scs--database
      # ISO 3166-1 region for phone validation (e.g. DE). Set in .env as NEXTCLOUD_NEXTCLOUD_DEFAULT_PHONE_REGION.
      - NEXTCLOUD_DEFAULT_PHONE_REGION=${NEXTCLOUD_NEXTCLOUD_DEFAULT_PHONE_REGION:-}
      # Email configuration (optional; configure via env or admin UI).
      - NEXTCLOUD_MAIL_MODE=${NEXTCLOUD_NEXTCLOUD_MAIL_MODE:-}
      - NEXTCLOUD_MAIL_SMTP_HOST=${NEXTCLOUD_NEXTCLOUD_MAIL_SMTP_HOST:-}
      - NEXTCLOUD_MAIL_SMTP_PORT=${NEXTCLOUD_NEXTCLOUD_MAIL_SMTP_PORT:-587}
      - NEXTCLOUD_MAIL_SMTP_SECURE=${NEXTCLOUD_NEXTCLOUD_MAIL_SMTP_SECURE:-tls}
      - NEXTCLOUD_MAIL_SMTP_AUTH=${NEXTCLOUD_NEXTCLOUD_MAIL_SMTP_AUTH:-1}
      - NEXTCLOUD_MAIL_SMTP_USERNAME=${NEXTCLOUD_NEXTCLOUD_MAIL_SMTP_USERNAME:-}
      - NEXTCLOUD_MAIL_SMTP_PASSWORD=${NEXTCLOUD_NEXTCLOUD_MAIL_SMTP_PASSWORD:-}
      - NEXTCLOUD_MAIL_FROM_ADDRESS=${NEXTCLOUD_NEXTCLOUD_MAIL_FROM_ADDRESS:-noreply}
      - NEXTCLOUD_MAIL_DOMAIN=${NEXTCLOUD_NEXTCLOUD_MAIL_DOMAIN:-}
      # Social Login configuration.
      - SOCIALLOGIN_ALLOW_LOGIN_CONNECT=${NEXTCLOUD_SOCIALLOGIN_ALLOW_LOGIN_CONNECT:-}
      - SOCIALLOGIN_AUTO_CREATE_GROUPS=${NEXTCLOUD_SOCIALLOGIN_AUTO_CREATE_GROUPS:-}
      - SOCIALLOGIN_BUTTON_TEXT_WO_PREFIX=${NEXTCLOUD_SOCIALLOGIN_BUTTON_TEXT_WO_PREFIX:-}
      - SOCIALLOGIN_CREATE_DISABLED_USERS=${NEXTCLOUD_SOCIALLOGIN_CREATE_DISABLED_USERS:-}
      - SOCIALLOGIN_DISABLE_NOTIFY_ADMINS=${NEXTCLOUD_SOCIALLOGIN_DISABLE_NOTIFY_ADMINS:-}
      - SOCIALLOGIN_DISABLE_REGISTRATION=${NEXTCLOUD_SOCIALLOGIN_DISABLE_REGISTRATION:-}
      - SOCIALLOGIN_HIDE_DEFAULT_LOGIN=${NEXTCLOUD_SOCIALLOGIN_HIDE_DEFAULT_LOGIN:-}
      - SOCIALLOGIN_NO_PRUNE_USER_GROUPS=${NEXTCLOUD_SOCIALLOGIN_NO_PRUNE_USER_GROUPS:-}
      - SOCIALLOGIN_PREVENT_CREATE_EMAIL_EXISTS=${NEXTCLOUD_SOCIALLOGIN_PREVENT_CREATE_EMAIL_EXISTS:-}
      - SOCIALLOGIN_RESTRICT_USERS_WO_ASSIGNED_GROUPS=${NEXTCLOUD_SOCIALLOGIN_RESTRICT_USERS_WO_ASSIGNED_GROUPS:-}
      - SOCIALLOGIN_RESTRICT_USERS_WO_MAPPED_GROUPS=${NEXTCLOUD_SOCIALLOGIN_RESTRICT_USERS_WO_MAPPED_GROUPS:-}
      - SOCIALLOGIN_UPDATE_PROFILE_ON_LOGIN=${NEXTCLOUD_SOCIALLOGIN_UPDATE_PROFILE_ON_LOGIN:-}
      - SOCIALLOGIN_CUSTOM_PROVIDERS=${NEXTCLOUD_SOCIALLOGIN_CUSTOM_PROVIDERS:-}
      - SOCIALLOGIN_KEYCLOAK_REALM=${NEXTCLOUD_SOCIALLOGIN_KEYCLOAK_REALM:-}
      - SOCIALLOGIN_KEYCLOAK_CLIENT_ID=${NEXTCLOUD_SOCIALLOGIN_KEYCLOAK_CLIENT_ID:-}
      - SOCIALLOGIN_KEYCLOAK_CLIENT_SECRET=${NEXTCLOUD_SOCIALLOGIN_KEYCLOAK_CLIENT_SECRET:-}
      - SOCIALLOGIN_KEYCLOAK_SCOPE=${NEXTCLOUD_SOCIALLOGIN_KEYCLOAK_SCOPE:-}
      - SOCIALLOGIN_KEYCLOAK_DISPLAY_NAME_CLAIM=${NEXTCLOUD_SOCIALLOGIN_KEYCLOAK_DISPLAY_NAME_CLAIM:-}
      - SOCIALLOGIN_KEYCLOAK_GROUPS_CLAIM=${NEXTCLOUD_SOCIALLOGIN_KEYCLOAK_GROUPS_CLAIM:-}
      - KC_DOMAIN=${KC_DOMAIN:-}
    networks:
      - default
      - reverse-proxy
    labels:
      - "traefik.enable=false"

  # OnlyOffice Document Server
  nextcloud--onlyoffice-document-server:
    container_name: nextcloud--onlyoffice-document-server
    networks:
      - default
      - reverse-proxy
    labels:
      - "traefik.enable=false"

  # Nginx Reverse Proxy for Nextcloud with Traefik
  nextcloud--nextcloud-reverse-proxy:
    container_name: nextcloud--nextcloud-reverse-proxy
    volumes:
      - ./scs-nextcloud-stack/reverse-proxy/nginx.conf:/etc/nginx/nginx.conf
    networks:
      - default
      - reverse-proxy
    ports: !reset []  # Remove port binding, use Traefik instead
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=reverse-proxy"
      - "traefik.http.routers.nextcloud--nextcloud-reverse-proxy.rule=Host(`${NEXTCLOUD_NEXTCLOUD_DOMAIN}`)"
      - "traefik.http.routers.nextcloud--nextcloud-reverse-proxy.entrypoints=web,websecure"
      - "traefik.http.routers.nextcloud--nextcloud-reverse-proxy.middlewares=https-redirect,nextcloud-redirectregex,nextcloud-webfinger,nextcloud-nodeinfo,rate-limit"
      - "traefik.http.routers.nextcloud--nextcloud-reverse-proxy.tls=true"
      - "traefik.http.routers.nextcloud--nextcloud-reverse-proxy.tls.certresolver=le"
      - "traefik.http.services.nextcloud--nextcloud-reverse-proxy.loadbalancer.server.port=80"

  # OnlyOffice Reverse Proxy with Traefik
  nextcloud--onlyoffice-reverse-proxy:
    container_name: nextcloud--onlyoffice-reverse-proxy
    volumes:
      - ./scs-nextcloud-stack/onlyoffice-proxy/nginx.conf:/etc/nginx/nginx.conf
    networks:
      - default
      - reverse-proxy
    ports: !reset []  # Remove port binding, use Traefik instead
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=reverse-proxy"
      - "traefik.http.routers.nextcloud--onlyoffice-reverse-proxy.rule=Host(`${NEXTCLOUD_ONLYOFFICE_DOMAIN}`)"
      - "traefik.http.routers.nextcloud--onlyoffice-reverse-proxy.entrypoints=web,websecure"
      - "traefik.http.routers.nextcloud--onlyoffice-reverse-proxy.middlewares=https-redirect"
      - "traefik.http.routers.nextcloud--onlyoffice-reverse-proxy.tls=true"
      - "traefik.http.routers.nextcloud--onlyoffice-reverse-proxy.tls.certresolver=le"
      - "traefik.http.services.nextcloud--onlyoffice-reverse-proxy.loadbalancer.server.port=80"

  # Redis for Nextcloud caching
  nextcloud--redis:
    container_name: nextcloud--redis

# Networks
networks:
  reverse-proxy:
    name: reverse-proxy
    external: true
