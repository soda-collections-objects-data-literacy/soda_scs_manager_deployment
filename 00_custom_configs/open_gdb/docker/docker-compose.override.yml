# Docker Compose Override for SCS OpenGDB Stack Integration
# This file overrides the base docker-compose.yml to integrate with the main SCS deployment
# It adds Traefik integration, proper networking, and consistent naming

services:
  # RDF4J Triplestore
  rdf4j:
    container_name: scs--rdf4j
    image: eclipse/rdf4j-workbench:5.1.0
    environment:
      - JAVA_OPTS=-Xms1g -Xmx6g -Dhttp.nonProxyHosts="" -Dhttp.proxyHost=scs--outproxy -Dhttp.proxyPort=8080 -Dhttps.proxyHost=scs--outproxy -Dhttps.proxyPort=8080
    networks:
      - default
      - reverse-proxy
    labels:
      - "traefik.enable=false"

  # Nginx Reverse Proxy with Traefik Integration
  nginx:
    container_name: scs--opengdb-proxy
    environment:
      AUTHPROXY_HOSTNAME: scs--authproxy
      RDF4J_HOSTNAME: scs--rdf4j
    volumes: !override
        - ./open_gdb/nginx/nginx.conf.template:/etc/nginx/templates/nginx.conf.template
    networks:
      - default
      - reverse-proxy
    ports: !reset []  # Remove port binding, use Traefik instead
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=reverse-proxy"
      - "traefik.http.routers.open-gdb--nginx.rule=Host(`${OPEN_GDB_DOMAIN}`)"
      - "traefik.http.routers.open-gdb--nginx.entrypoints=websecure"
      - "traefik.http.routers.open-gdb--nginx.tls=true"
      - "traefik.http.routers.open-gdb--nginx.tls.certresolver=le"
      - "traefik.http.services.open-gdb--nginx.loadbalancer.server.port=80"

  # Outproxy for external HTTP requests
  outproxy:
    container_name: scs--outproxy
    build: !reset []
    networks:
      - default
      - reverse-proxy
    labels:
      - "traefik.enable=false"

  # Authentication Proxy
  authproxy:
    container_name: scs--authproxy
    build: !reset []
    networks:
      - default
      - reverse-proxy
    labels:
      - "traefik.enable=false"

# Networks
networks:
  default:
    name: open_gdb
    driver: bridge
