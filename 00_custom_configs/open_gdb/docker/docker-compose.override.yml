# Docker Compose Override for SCS OpenGDB Stack Integration
# This file overrides the base docker-compose.yml to integrate with the main SCS deployment
# It adds Traefik integration, proper networking, and consistent naming

services:
  # RDF4J Triplestore
  open-gdb--rdf4j:
    container_name: scs--rdf4j
    image: eclipse/rdf4j-workbench:5.1.0
    environment:
      - JAVA_OPTS=-Xms1g -Xmx6g -Dhttp.nonProxyHosts="" -Dhttp.proxyHost=outproxy -Dhttp.proxyPort=8080 -Dhttps.proxyHost=outproxy -Dhttps.proxyPort=8080
    networks:
      - default
      - reverse-proxy
    labels:
      - "traefik.enable=false"

  # Nginx Reverse Proxy with Traefik Integration
  open-gdb--nginx:
    container_name: scs--opengdb-proxy
    volumes:
      - ./open_gdb/opengdb_proxy/nginx.conf:/etc/nginx/nginx.conf:ro
    networks:
      - default
      - reverse-proxy
    ports: !reset []  # Remove port binding, use Traefik instead
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=reverse-proxy"
      - "traefik.http.routers.open-gdb--nginx.rule=Host(`${OPEN_GDB_DOMAIN}`)"
      - "traefik.http.routers.open-gdb--nginx.entrypoints=web,websecure"
      - "traefik.http.routers.open-gdb--nginx.middlewares=https-redirect,rate-limit"
      - "traefik.http.routers.open-gdb--nginx.tls=true"
      - "traefik.http.routers.open-gdb--nginx.tls.certresolver=le"
      - "traefik.http.services.open-gdb--nginx.loadbalancer.server.port=80"

  # Outproxy for external HTTP requests
  open-gdb--outproxy:
    container_name: scs--outproxy
    networks:
      - default
      - reverse-proxy
    labels:
      - "traefik.enable=false"

  # Authentication Proxy
  open-gdb--authproxy:
    container_name: scs--authproxy
    networks:
      - default
      - reverse-proxy
    labels:
      - "traefik.enable=false"

# Networks
networks:
  reverse-proxy:
    name: reverse-proxy
    external: true
  default:
    name: open_gdb
    driver: bridge
