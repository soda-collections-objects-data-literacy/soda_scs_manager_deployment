#todo use label mappings

services:
  # Filemanagement
  scs--access-proxy:
    image: alpine:latest
    container_name: scs--access-proxy
    restart: unless-stopped
    command: >
      sh -c "id filemanager >/dev/null 2>&1 || adduser -D -u 9000 filemanager && id www-data >/dev/null 2>&1 || adduser -D -u 33 -G www-data www-data && tail -f /dev/null"
    volumes:
      - scs--shared-data:/shared
      - /var/backups/scs-manager/snapshots:/var/scs-manager/snapshots
    networks:
      - reverse-proxy
    labels:
      - "traefik.enable=false"

  # SCS Manager
  scs--portainer:
    image: portainer/portainer-ce:2.33.6
    container_name: scs--portainer
    command: -H unix:///var/run/docker.sock
    volumes:
      - scs--portainer-data:/data
      - /var/run/docker.sock:/var/run/docker.sock
    depends_on:
      - scs--reverse-proxy
    networks:
      - reverse-proxy
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=reverse-proxy"
      - "traefik.http.routers.scs--portainer.rule=Host(`${SCS_PORTAINER_DOMAIN}`)"
      - "traefik.http.routers.scs--portainer.entrypoints=web,websecure"
      - "traefik.http.routers.scs--portainer.tls=true"
      - "traefik.http.routers.scs--portainer.tls.certresolver=le"
      - "traefik.http.services.scs--portainer.loadbalancer.server.port=9000"
      - "traefik.http.routers.scs--portainer.service=scs--portainer"
      - "traefik.http.routers.scs--portainer-edge.rule=Host(`${SCS_PORTAINER_EDGE_DOMAIN}`)"
      - "traefik.http.routers.scs--portainer-edge.entrypoints=web,websecure"
      - "traefik.http.services.scs--portainer-edge.loadbalancer.server.port=8000"
      - "traefik.http.routers.scs--portainer-edge.service=scs--portainer"
    restart: unless-stopped

  # SQL database
  scs--database:
    image: mariadb:11.5.2
    container_name: scs--database
    command: >
      --transaction-isolation=READ-COMMITTED
      --innodb-buffer-pool-size=8G
      --innodb-buffer-pool-instances=16
      --innodb-log-file-size=1G
      --innodb-log-buffer-size=128M
      --innodb-flush-log-at-trx-commit=2
      --innodb-flush-method=O_DIRECT
      --innodb-file-per-table=1
      --innodb-read-io-threads=8
      --innodb-write-io-threads=8
      --innodb-io-capacity=4000
      --innodb-io-capacity-max=8000
      --innodb-purge-threads=8
      --innodb-page-cleaners=8
      --innodb-adaptive-hash-index=1
      --innodb-change-buffering=all
      --max-connections=1000
      --max-user-connections=900
      --table-open-cache=16000
      --table-definition-cache=8000
      --thread-cache-size=200
      --tmp-table-size=256M
      --max-heap-table-size=256M
      --join-buffer-size=16M
      --sort-buffer-size=16M
      --read-buffer-size=4M
      --read-rnd-buffer-size=8M
      --binlog-cache-size=4M
      --max-binlog-size=512M
      --expire-logs-days=7
      --slow-query-log=1
      --slow-query-log-file=/var/log/mysql/slow-query.log
      --long-query-time=2
      --log-queries-not-using-indexes=1
      --log-slow-admin-statements=1
      --character-set-server=utf8mb4
      --collation-server=utf8mb4_unicode_ci
      --max-allowed-packet=128M
      --wait-timeout=600
      --interactive-timeout=600
      --net-read-timeout=60
      --net-write-timeout=60
      --back-log=500
      --thread-stack=512K
    environment:
      MYSQL_ROOT_PASSWORD: ${SCS_DB_ROOT_PASSWORD}
    volumes:
      - scs--database-data:/var/lib/mysql
      - /srv/backups/scs-manager/snapshots:/var/scs-manager/snapshots
    depends_on:
      - scs--reverse-proxy
      - scs--portainer
    networks:
      - reverse-proxy
    labels:
      - "traefik.enable=false"
    restart: unless-stopped

  scs--adminer:
    image: adminer
    container_name: scs--adminer
    restart: unless-stopped
    depends_on:
      - scs--database
      - scs--reverse-proxy
    networks:
      - reverse-proxy
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=reverse-proxy"
      - "traefik.http.routers.scs--adminer.rule=Host(`${SCS_ADMINER_DOMAIN:-adminer.localhost}`)"
      - "traefik.http.routers.scs--adminer.entrypoints=websecure"
      - "traefik.http.routers.scs--adminer.tls=true"
      - "traefik.http.routers.scs--adminer.tls.certresolver=le"
      - "traefik.http.services.scs--adminer.loadbalancer.server.port=8080"

  # Whoami for debugging routing + proxy-header stuff
  scs--echo:
    image: traefik/whoami
    container_name: scs--echo
    networks:
      - reverse-proxy
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.scs--echo.rule=Host(`echo.${SCS_SUBDOMAIN}.${SCS_BASE_DOMAIN}`)"
      - "traefik.http.routers.scs--echo.entrypoints=websecure"
      - "traefik.http.routers.scs--echo.tls=true"
      - "traefik.http.routers.scs--echo.tls.certresolver=le"
      - "traefik.http.services.scs--echo.loadbalancer.server.port=80"
    restart: unless-stopped

  # Traefik
  scs--reverse-proxy:
    image: traefik:3.6
    container_name: scs--reverse-proxy
    ports:
      - "80:80"
      - "443:443"
    networks:
      - reverse-proxy
    labels:
      - "traefik.enable=true"
      # - "traefik.docker.network=reverse-proxy"  this should not be needed.

      # Middlewares
      ## Basic Auth
      - "traefik.http.middlewares.admin-auth.basicauth.users=${SCS_TRAEFIK_USERNAME}:${SCS_TRAEFIK_HASHED_PASSWORD}"

      ## Redirect to SCS Manager
      - "traefik.http.middlewares.redirect-to-scs-manager--drupal.redirectregex.regex=^https?://${SCS_SUBDOMAIN}\\.${SCS_BASE_DOMAIN}(.*)"
      - "traefik.http.middlewares.redirect-to-scs-manager--drupal.redirectregex.replacement=https://${SCS_MANAGER_DOMAIN}$${1}"
      - "traefik.http.middlewares.redirect-to-scs-manager--drupal.redirectregex.permanent=true"

      ## Bot Protection Middlewares for Heavy Traffic Sites
      ## High-traffic rate limit: 300 requests per minute per IP (for main sites)
      ## To use: Add "rate-limit-high" to a service's middlewares list
      - "traefik.http.middlewares.rate-limit-high.ratelimit.average=300"
      - "traefik.http.middlewares.rate-limit-high.ratelimit.period=1m"
      - "traefik.http.middlewares.rate-limit-high.ratelimit.burst=100"
      ## Moderate rate limit: 150 requests per minute per IP (for APIs/services)
      ## To use: Add "rate-limit" to a service's middlewares list
      - "traefik.http.middlewares.rate-limit.ratelimit.average=150"
      - "traefik.http.middlewares.rate-limit.ratelimit.period=1m"
      - "traefik.http.middlewares.rate-limit.ratelimit.burst=50"
      ## Stricter rate limit for aggressive bots: 60 requests per minute
      ## To use: Add "rate-limit-strict" to a service's middlewares list
      - "traefik.http.middlewares.rate-limit-strict.ratelimit.average=60"
      - "traefik.http.middlewares.rate-limit-strict.ratelimit.period=1m"
      - "traefik.http.middlewares.rate-limit-strict.ratelimit.burst=20"

      # Routers
      - "traefik.http.routers.scs--reverse-proxy.rule=Host(`${SCS_TRAEFIK_DOMAIN:-traefik.localhost}`)"
      - "traefik.http.routers.scs--reverse-proxy.entrypoints=websecure"
      - "traefik.http.routers.scs--reverse-proxy.middlewares=admin-auth"
      - "traefik.http.routers.scs--reverse-proxy.tls=true"
      - "traefik.http.routers.scs--reverse-proxy.tls.certresolver=le"
      - "traefik.http.routers.scs--reverse-proxy.service=api@internal"
      ## Redirect router for scs.sammlungen.io -> manager.scs.sammlungen.io
      ## @todo check if this is the right place.
      - "traefik.http.routers.scs-manager-redirect.rule=Host(`${SCS_MANAGER_SECOND_DOMAIN}`)"
      - "traefik.http.routers.scs-manager-redirect.entrypoints=websecure"
      - "traefik.http.routers.scs-manager-redirect.middlewares=redirect-to-scs-manager--drupal"
      - "traefik.http.routers.scs-manager-redirect.tls=true"
      - "traefik.http.routers.scs-manager-redirect.tls.certresolver=le"

    restart: unless-stopped
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - ./acme.json:/certificates/acme.json
    command:
      # Enable Docker provider
      - --providers.docker
      # Disable exposing services without Traefik labels
      - --providers.docker.exposedbydefault=false
      # Listen on port 80 for HTTP requests
      - --entrypoints.web.address=:80
      # Allow bypassing the ACME challenge at /.well-known/acme-challenge
      # Define a new router like this:
      # http_acme_passthough_my.domain:
      #   rule: "Host(`my.domain`) && PathPrefix(`/.well-known/acme-challenge/`)"
      #   entryPoints: ["web"]
      #   service: "proxy_https_my.domain"
      #   priority:  "43" # THIS IS IMPORTANT priority has to be > 42 otherwise this does not work.
      - --entrypoints.web.allowACMEByPass=true
      # Listen on port 443 for HTTPS requests
      - --entrypoints.websecure.address=:443
      # Http to https redirect
      - --entrypoints.web.http.redirections.entryPoint.to=websecure
      - --entrypoints.web.http.redirections.entryPoint.scheme=https
      - --entrypoints.web.http.redirections.entryPoint.permanent=true
      - --entrypoints.web.http.redirections.entryPoint.priority=43
      # Use the specified email address for Let's Encrypt certificate requests
      - --certificatesresolvers.le.acme.email=${SCS_TRAEFIK_EMAIL:-admin@example.com}
      # Use the HTTP challenge for Let's Encrypt certificate requests
      - --certificatesresolvers.le.acme.httpchallenge.entrypoint=web
      # Use the specified storage location for Let's Encrypt certificates
      - --certificatesresolvers.le.acme.storage=/certificates/acme.json
      # Use the TLS-ALPN-01 challenge for Let's Encrypt certificate requests
      - --certificatesresolvers.le.acme.tlschallenge=true
      # Enable access log output
      - --accesslog
      # Enable general log output
      - --log
      # Enable the Traefik API
      - --api
      # Enable the Traefik API dashboard
      - --api.dashboard=true


volumes:
  scs--database-data:
    name: scs--database-data
  scs--portainer-data:
    name: scs--portainer-data
  scs--reverse-proxy-certificates:
    name: scs--reverse-proxy-certificates
  scs--shared-data:
    name: ${SCS_SHARED_DATA}

networks:
  reverse-proxy:
    name: reverse-proxy
    # enable_ipv6: true
    driver: bridge
