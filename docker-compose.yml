#todo use label mappings

services:
  # Filemanagement
  access-proxy:
    image: alpine:latest
    container_name: access-proxy
    restart: unless-stopped
    command: >
      sh -c "id filemanager >/dev/null 2>&1 || adduser -D -u 9000 filemanager && id www-data >/dev/null 2>&1 || adduser -D -u 33 -G www-data www-data && tail -f /dev/null"
    volumes:
      - shared-data:/shared
      - /var/backups/scs-manager/snapshots:/var/scs-manager/snapshots
    networks:
      - reverse-proxy
    labels:
      - "traefik.enable=false"

  # SCS Manager
  portainer:
    image: portainer/portainer-ce:2.33.5
    container_name: portainer
    command: -H unix:///var/run/docker.sock
    volumes:
      - portainer-data:/data
      - /var/run/docker.sock:/var/run/docker.sock
    depends_on:
      - traefik
    networks:
      - reverse-proxy
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=reverse-proxy"
      - "traefik.http.routers.portainer.rule=Host(`${SCS_PORTAINER_TLD}.${SCS_SLD}`)"
      - "traefik.http.routers.portainer.entrypoints=web,websecure"
      - "traefik.http.routers.portainer.middlewares=https-redirect"
      - "traefik.http.routers.portainer.tls=true"
      - "traefik.http.routers.portainer.tls.certresolver=le"
      - "traefik.http.services.portainer.loadbalancer.server.port=9000"
      - "traefik.http.routers.portainer.service=portainer"
      - "traefik.http.routers.edge.rule=Host(`${SCS_PORTAINER_EDGE_TLD}.${SCS_SLD}`)"
      - "traefik.http.routers.edge.entrypoints=web,websecure"
      - "traefik.http.services.edge.loadbalancer.server.port=8000"
      - "traefik.http.routers.edge.service=edge"
      - "traefik.http.routers.edge.middlewares=https-redirect"
    restart: unless-stopped

  # SQL database
  database:
    image: mariadb:11.5.2
    container_name: database
    command: >
      --transaction-isolation=READ-COMMITTED
      --innodb-buffer-pool-size=8G
      --innodb-buffer-pool-instances=16
      --innodb-log-file-size=1G
      --innodb-log-buffer-size=128M
      --innodb-flush-log-at-trx-commit=2
      --innodb-flush-method=O_DIRECT
      --innodb-file-per-table=1
      --innodb-read-io-threads=8
      --innodb-write-io-threads=8
      --innodb-io-capacity=4000
      --innodb-io-capacity-max=8000
      --innodb-purge-threads=8
      --innodb-page-cleaners=8
      --innodb-adaptive-hash-index=1
      --innodb-change-buffering=all
      --max-connections=1000
      --max-user-connections=900
      --table-open-cache=16000
      --table-definition-cache=8000
      --thread-cache-size=200
      --tmp-table-size=256M
      --max-heap-table-size=256M
      --join-buffer-size=16M
      --sort-buffer-size=16M
      --read-buffer-size=4M
      --read-rnd-buffer-size=8M
      --binlog-cache-size=4M
      --max-binlog-size=512M
      --expire-logs-days=7
      --slow-query-log=1
      --slow-query-log-file=/var/log/mysql/slow-query.log
      --long-query-time=2
      --log-queries-not-using-indexes=1
      --log-slow-admin-statements=1
      --character-set-server=utf8mb4
      --collation-server=utf8mb4_unicode_ci
      --max-allowed-packet=128M
      --wait-timeout=600
      --interactive-timeout=600
      --net-read-timeout=60
      --net-write-timeout=60
      --back-log=500
      --thread-stack=512K
    environment:
      MYSQL_ROOT_PASSWORD: ${SCS_DB_ROOT_PASSWORD}
      MYSQL_DATABASE: ${SCS_DB_NAME}
      MYSQL_USER: ${SCS_DB_USER}
      MYSQL_PASSWORD: ${SCS_DB_PASSWORD}
    volumes:
      - database-data:/var/lib/mysql
      - /var/scs-manager/snapshots:/var/scs-manager/snapshots
      - ./scripts/database:/var/scs-manager/scripts/database
    ports:
      - 3306:3306
    depends_on:
      - traefik
      - portainer
    networks:
      - reverse-proxy
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=reverse-proxy"
      - "traefik.tcp.routers.database.entrypoints=mysql"
      - "traefik.tcp.routers.database.rule=HostSNI(`${SCS_DB_TLD:-db}.${SCS_SLD:-localhost}`)"
      - "traefik.tcp.routers.database.tls=true"
      - "traefik.tcp.routers.database.tls.certresolver=le"
      - "traefik.tcp.routers.database.tls.passthrough=true"
      - "traefik.tcp.services.database.loadbalancer.server.port=3306"
    restart: unless-stopped

  adminer:
    image: adminer
    container_name: adminer
    restart: unless-stopped
    depends_on:
      - database
      - traefik
    networks:
      - reverse-proxy
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=reverse-proxy"
      - "traefik.http.routers.adminer.rule=Host(`${SCS_ADMINER_TLD:-adminer}.${SCS_SLD:-localhost}`)"
      - "traefik.http.routers.adminer.entrypoints=web,websecure"
      - "traefik.http.routers.adminer.middlewares=https-redirect"
      - "traefik.http.routers.adminer.tls=true"
      - "traefik.http.routers.adminer.tls.certresolver=le"
      - "traefik.http.services.adminer.loadbalancer.server.port=8080"

  # Traefik
  traefik:
    image: traefik:3.6
    container_name: traefik
    ports:
      - 80:80
      - 443:443
    networks:
      - reverse-proxy
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=reverse-proxy"

      # Middlewares
      ## Basic Auth
      - "traefik.http.middlewares.admin-auth.basicauth.users=${SCS_TRAEFIK_USERNAME:-admin}:${SCS_TRAEFIK_HASHED_PASSWORD:-changeme}"
      ## Redirect HTTP to HTTPS
      - "traefik.http.middlewares.https-redirect.redirectscheme.scheme=https"
      - "traefik.http.middlewares.https-redirect.redirectscheme.permanent=true"
      - "traefik.http.middlewares.https-redirect.redirectscheme.port=443"
      ## Nextcloud Headers
      - "traefik.http.middlewares.nextcloud-headers.headers.stsSeconds=15552000"
      - "traefik.http.middlewares.nextcloud-headers.headers.stsIncludeSubdomains=true"
      - "traefik.http.middlewares.nextcloud-headers.headers.stsPreload=true"
      - "traefik.http.middlewares.nextcloud-headers.headers.forceSTSHeader=true"

      ## Nextcloud redirectregex Middleware f√ºr .well-known Endpoints
      - "traefik.http.middlewares.nextcloud-redirectregex.redirectregex.permanent=true"
      # Carddav und Caldav
      - "traefik.http.middlewares.nextcloud-redirectregex.redirectregex.regex=^https?://([^/]+)/\\.well-known/(card|cal)dav"
      - "traefik.http.middlewares.nextcloud-redirectregex.redirectregex.replacement=https://$${1}/remote.php/dav"
      # Webfinger
      - "traefik.http.middlewares.nextcloud-webfinger.redirectregex.permanent=true"
      - "traefik.http.middlewares.nextcloud-webfinger.redirectregex.regex=^https?://([^/]+)/\\.well-known/webfinger"
      - "traefik.http.middlewares.nextcloud-webfinger.redirectregex.replacement=https://$${1}/index.php/.well-known/webfinger"
      # Nodeinfo
      - "traefik.http.middlewares.nextcloud-nodeinfo.redirectregex.permanent=true"
      - "traefik.http.middlewares.nextcloud-nodeinfo.redirectregex.regex=^https?://([^/]+)/\\.well-known/nodeinfo"
      - "traefik.http.middlewares.nextcloud-nodeinfo.redirectregex.replacement=https://$${1}/index.php/.well-known/nodeinfo"

      # Routers
      - "traefik.http.routers.reverse-proxy.rule=Host(`${SCS_TRAEFIK_TLD:-traefik}.${SCS_SLD:-localhost}`)"
      - "traefik.http.routers.reverse-proxy.entrypoints=web,websecure"
      - "traefik.http.routers.reverse-proxy.middlewares=admin-auth,https-redirect"
      - "traefik.http.routers.reverse-proxy.tls=true"
      - "traefik.http.routers.reverse-proxy.tls.certresolver=le"
      - "traefik.http.routers.reverse-proxy.service=api@internal"

    restart: unless-stopped
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - reverse-proxy-certificates:/certificates
    command:
      # Enable Docker provider
      - --providers.docker
      # Disable exposing services without Traefik labels
      - --providers.docker.exposedbydefault=false
      # Listen on port 80 for HTTP requests
      - --entrypoints.web.address=:80
      # Listen on port 443 for HTTPS requests
      - --entrypoints.websecure.address=:443
      # Listen on port 3306 for MySQL requests
      - --entrypoints.mysql.address=:3306
      # Redirect HTTP requests to HTTPS
      - --entrypoints.web.http.redirections.entryPoint.to=websecure
      - --entrypoints.web.http.redirections.entryPoint.scheme=https
      - --entrypoints.web.http.redirections.entrypoint.permanent=true
      # Use the specified email address for Let's Encrypt certificate requests
      - --certificatesresolvers.le.acme.email=${SCS_TRAEFIK_EMAIL:-admin@example.com}
      # Use the HTTP challenge for Let's Encrypt certificate requests
      - --certificatesresolvers.le.acme.httpchallenge.entrypoint=web
      # Use the specified storage location for Let's Encrypt certificates
      - --certificatesresolvers.le.acme.storage=/certificates/acme.json
      # Use the TLS-ALPN-01 challenge for Let's Encrypt certificate requests
      - --certificatesresolvers.le.acme.tlschallenge=true
      # Enable access log output
      - --accesslog
      # Enable general log output
      - --log
      # Enable the Traefik API
      - --api
      # Enable the Traefik API dashboard
      - --api.dashboard=true

volumes:
  database-data:
  portainer-data:
  reverse-proxy-certificates:
  shared-data:

networks:
  reverse-proxy:
    name: reverse-proxy
    external: true
